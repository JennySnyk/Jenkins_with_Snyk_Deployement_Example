// Snyk Code (SAST) Security Pipeline
// Scans application source code for security vulnerabilities
//
// âš ï¸  REGIONAL HOSTING: If you're using Snyk EU, AU, or US-02 tenants:
// 1. Configure your region: snyk config environment SNYK-EU-01 (or SNYK-AU-01, SNYK-US-02)
// 2. More info: https://docs.snyk.io/snyk-data-and-governance/regional-hosting-and-data-residency

pipeline {
    agent any
    
    environment {
        // Configure your Snyk API token as a Jenkins credential with ID 'snyk-api-token'
        SNYK_TOKEN = credentials('snyk-api-token')
        REPO_URL = 'https://github.com/snyk-labs/nodejs-goof.git'
        BRANCH = 'main'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo 'ğŸ”„ Checking out application code...'
                git branch: "${BRANCH}", url: "${REPO_URL}"
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installing npm dependencies...'
                sh '''
                    node --version
                    npm --version
                    npm install
                '''
            }
        }
        
        stage('Snyk Code Scan (SAST)') {
            steps {
                echo 'ğŸ” Scanning for code vulnerabilities with Snyk Code...'
                script {
                    sh '''
                        # For EU tenant users, configure your region first:
                        # snyk config environment SNYK-EU-01
                        
                        # Authenticate with Snyk
                        snyk auth ${SNYK_TOKEN}
                        
                        # Run Snyk Code test
                        snyk code test \
                            --json-file-output=snyk-code-results.json \
                            || true
                    '''
                }
            }
        }
        
        stage('Generate Report Summary') {
            steps {
                echo 'ğŸ“‹ Generating vulnerability summary...'
                sh '''
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘     SNYK CODE SECURITY SCAN SUMMARY                â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    
                    if [ -f snyk-code-results.json ]; then
                        echo "ğŸ” Snyk Code (SAST) Scan Results:"
                        echo "   âœ“ Scan completed - Check archived report for details"
                        echo ""
                    fi
                    
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“Š View detailed results in the archived artifacts!"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                '''
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ Archiving Snyk Code scan results...'
            archiveArtifacts artifacts: 'snyk-code-results.json', allowEmptyArchive: true, fingerprint: true
        }
        
        success {
            echo 'âœ… Security scan pipeline completed successfully!'
            echo ''
            echo 'ğŸ“Š RESULTS AVAILABLE IN:'
            echo '  â€¢ Archived Artifacts (click on build number, then "Artifacts")'
            echo '  â€¢ Snyk Web Dashboard: https://app.snyk.io'
        }
        
        failure {
            echo 'âŒ Pipeline failed! Check the logs above.'
        }
    }
}

